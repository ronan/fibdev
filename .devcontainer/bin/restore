#!/bin/bash
set -e

header "    â¬†ï¸  Restoring application ...      "

cd /workspace

echo "ğŸ—‘ï¸  Deleting logs, databases and temporary files ..."
mkdir -p data/logs data/tmp outbox
rotate-logs

echo "ğŸ“¥ Cloning codebase ... "
if [ ! -d /workspace/root ]; then
  if [ -n "$GIT_URL" ]; then
    git clone $GIT_URL -b "${GIT_BRANCH:-main}" /workspace/root
    git clone $GIT_URL -b "${GIT_BRANCH:-main}" /workspace/root
    git config --global --add safe.directory /workspace/root
    if [ -n "$GIT_COMMIT_SHA" ]; then
      cd /workspace/root
      git reset --hard "$GIT_COMMIT_SHA"
    fi
  else
    echo "ğŸ˜µ Please place the site in /workspace/root or specify a GIT_URL in ./.env"
    exit
  fi
fi

echo "ğŸ¶ Running composer install"
if [ -d /workspace/root ]; then
  cd /workspace/root && composer install
fi

echo "ğŸ“ Resetting site files ..."
if [ -d /workspace/inbox/files ] && [ ! -d /workspace/root/sites/default/files ]; then
    rm -rf /workspace/root/files
    ln -s /workspace/inbox/files /workspace/root/sites/default/files
fi

echo "ğŸ“ Adding local config overrides ..."
src="/workspace/.devcontainer/drupal/settings.local.php"
dst="/workspace/root/web/sites/default/settings.local.php"
if is-backdrop; then
  src="/workspace/.devcontainer/app/backdrop.settings.local.php"
  dst="/workspace/root/settings.local.php"
fi
if [ ! -f "$dst" ]; then
  if [ ! -f /workspace/inbox/settings.local.php ]; then
    cp $src /workspace/inbox/settings.local.php
  fi
  ln -s /workspace/inbox/settings.local.php $dst
fi
ln -fs /workspace/.devcontainer/app/info.php /workspace/root/web/info.php

say "ğŸ”¨ Deleting and recreating DB ..."
mariadb -h db --password=root -e 'DROP DATABASE IF EXISTS app; CREATE DATABASE app'

say "ğŸ“¦ Importing SQL dump ..."
db-import

echo "ğŸ–¼ï¸ Installing and Configuring stage_file_proxy"
cd /workspace/root
composer require drupal/stage_file_proxy
app en stage_file_proxy
drush -y cset stage_file_proxy.settings origin "$PROD_URL"

# echo "ğŸ–¼ï¸ Enabling theme debugging"

echo "ğŸ–Œï¸ Buiding theme assets"
task build-theme

app deploy

echo "

ğŸ‰ ğŸ‰ ğŸ‰ Restore Complete! ğŸ‰ ğŸ‰ ğŸ‰

"
uli

echo